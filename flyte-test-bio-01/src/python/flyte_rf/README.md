# Create proteins using diffusion

Let's try to design a new protein!

## Background

Here we will design a collection of proteins using [ProteinMPNN](https://github.com/dauparas/ProteinMPNN) and
[foldingdiff](https://github.com/microsoft/foldingdiff).  foldingdiff is not the best protein diffusion
model/framework out there, but it is by far the easiest to install.  So you shouldn't expect great results.


First we will use foldingdiff to diffuse a series of new protein backbones.  Then we will assign protein
sequence to that backbone via ProteinMPNN.  Next we will use [ESMfold](https://github.com/facebookresearch/esm)
to fold the sequence predicted by ProteinMPNN.  Finally, we will compare the structure generated by ESMfold
to the initial prediction by foldingdiff, and use this comparison to rank our designs.


## Verbose Code Workflow

```

# Slow (~10-60min X 100,000)
protein_backbones = Use foldingdiff to diffuse a set of protein backbones

# Fast (~0.5min X 100,000)
sequences_to_try_folding = []
for protein_backbone in protein_backbones:
    protein_backbone_sequences = Use ProteinMPNN to get N protein sequences for each protein_backbone
    sequences_to_try_folding += protein_backbone_sequences

folding_results = []
# Fast (~1-10min X (N*100,000)), but container is large so input lists of sequences
for protein_backbone_sequence in protein_backbone_sequences:
    protein_backbone_sequence_folded = Use ESMFold to create a protein model for the protein_backbone_sequence
    folding_results += protein_backbone_sequence_folded

keepers = []
for (protein_backbone, sequence, sequence_folded) in zip(protein_backbones, sequences_to_try_folding, folding_results):
    metrics = analyze protein_backbone and sequence_folded to see if they're similar
    if metrics are good:
        keepers += (protein_backbone, sequence, sequence_folded, metrics)

sort keepers by metrics

# pull to your local computer to either do more analysis or manually inspect ...

```

## Development environments

I've laid out the project so that python type checkers like pyright/pylance will not break, you will
just need to manage your environments carefully, and switch environments when you switch to developing on
different containers.


You can check out the `Dockerfiles` to see how to recreate the development environments.

## Preparing the cluster

__Note `docker push` is just terribly slow for some reason, if you can use podman, I would suggest it! (change the DOCKER_OR_PODMAN variable in the setup_demo_cluster.sh script)__


I've made it very simple to get you started with this demo, just run `sh ./setup_demo_cluster.sh` and it will:
- setup the demo cluster
- build the images & push the images to the cluster
- modify the cluster to allow more compute intensive jobs


## Run a job

```
pyflyte run --remote flyte_diffuse_design_fold/master.py run_rf_mpnn_esm_wf  --input_pdb_file ./1ycr.pdb --diffusion_num_designs 5 --foldingdiff_commandline_args '["-b", "512"]' --protein_mpnn_commandline_args '["--omit_AAs", "AC", "--ca_only"]' --protein_mpnn_num_designs 2
```

